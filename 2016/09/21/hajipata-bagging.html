<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="author" content="ysk24ok">
  
  <meta name="description" content="はじめてのパターン認識 第11章のbaggingについてまとめた。">
  <meta property="og:description" content="はじめてのパターン認識 第11章のbaggingについてまとめた。">
  
  <meta property="og:image" content="https://ysk24ok.github.io/assets/images/profile.jpeg">
  <meta property="og:title" content="はじめてのパターン認識 第11章 bagging">
  <meta property="og:url" content="https://ysk24ok.github.io/2016/09/21/hajipata-bagging.html">
  <meta property="og:type" content="article">
  <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
  <!-- MathJax -->
  <!-- http://docs.mathjax.org/en/latest/start.html#secure-access-to-the-cdn -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(','\\)'] ],
        processEscapes: true
      }
    });
  </script>
  <script type="text/javascript" async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!-- bootstrap -->
  <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.min.css">
  <script src="/assets/js/jquery-2.1.4.min.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>
  <!-- github.io default -->
  <link rel="stylesheet" type="text/css" href="/assets/css/stylesheet.css" media="screen">
  <link rel="stylesheet" type="text/css" href="/assets/css/github-dark.css" media="screen">
  <link rel="stylesheet" type="text/css" href="/assets/css/print.css" media="print">
  <!-- syntax highlight css -->
  <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" media="screen">
  <!-- My customized css -->
  <link rel="stylesheet" type="text/css" href="/assets/css/main.css" media="screen">
  <!-- RSS -->
  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="ysk24ok.github.io" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-131519041-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-131519041-1');
  </script>
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <title>はじめてのパターン認識 第11章 bagging - ysk24ok.github.io</title>
</head>

  <body>
    <div id="container">
      <div class="inner">
        <header>
  <h1><a href="/">ysk24ok.github.io</a></h1>
</header>
<nav class="navbar navbar-default" role="navigation">
  <ul id="main-navigation" class="nav navbar-nav">
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
  </ul>
</nav>

        <div class="post-item">
          <div class="post-header">
  <h1>
    <a href="/2016/09/21/hajipata-bagging.html">はじめてのパターン認識 第11章 bagging</a>
  </h1>
  <ul class="post-tags">
    
      <li><a href="#">hajipata</a></li>
    
      <li><a href="#">ensemble learning</a></li>
    
      <li><a href="#">Japanese</a></li>
    
  </ul>
  
  <div class="post-date">posted on 21 Sep 2016</div>
  
  <hr>
</div>

          <div class="post-content">
            <ul class="social-buttons">
  <!-- hatena bookmark -->
  <li>
    <a href="http://b.hatena.ne.jp/entry/ysk24ok.github.io/2016/09/21/hajipata-bagging.html" class="hatena-bookmark-button" data-hatena-bookmark-title="はじめてのパターン認識 第11章 bagging - ysk24ok.github.io" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加">
      <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
    </a>
    <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
  <!-- twitter -->
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </li>
</ul>

            <div class="post-img">
  <img src="/assets/images/hajipata/cover.jpg" width="20%" />
</div>

<p><a href="https://www.morikita.co.jp/books/book/2235">はじめてのパターン認識</a> 第11章のbaggingについてまとめた。</p>

<!-- more -->

<h2 id="baggingとは">baggingとは</h2>

<p>学習データのブートストラップサンプルを用いて複数の弱学習器を独立に学習させ、<br />
それらを組み合わせて強学習器を作るアンサンブル学習の1種。<br />
分類問題では多数決で、回帰問題では平均をとることで<br />
新しい入力サンプルに対する予測をおこなう。</p>

<p>ちなみにブートストラップサンプリングとは、<br />
サンプル集合$X$から重複ありで抽出して新たなサンプル集合$X^{‘}$を作る手法である。</p>

<h3 id="特徴">特徴</h3>

<ul>
  <li>各学習器は独立しているため<br />
学習を並列化して学習時間を短縮させることができる。</li>
  <li>バリアンスを低減できるため<br />
弱学習器には高バリアンスな決定木などがよく使用される。</li>
  <li>多数決or平均をとるため過学習を防ぐことができる。<br />
そのため、最大までノードを分割した木が使うのが良い。</li>
  <li>学習器が持つばらつきにはブートストラップサンプルのばらつきが反映されるのみなので、
決定木の相関が高くなってしまい十分な性能強化ができない可能性がある。
    <ul>
      <li>この点を改良したのがboostingやrandom forestである。</li>
    </ul>
  </li>
</ul>

<h3 id="アルゴリズム">アルゴリズム</h3>

<ul>
  <li>学習データ: $\mathbf{x}_{i}\in \mathbb{R}^{d}, t_{i}=\{-1, +1\}\quad(i=1,\cdots,N)$</li>
  <li>弱学習器: $y_m(\mathbf{x})\quad(m=1,\cdots,M)$
    <ul>
      <li>識別問題: $y_m(\mathbf{x})=\{-1,+1\}$</li>
      <li>回帰問題: $y_m(\mathbf{x})\in\mathbb{R}$</li>
    </ul>
  </li>
</ul>

<ol>
  <li>各学習器$y_{m}$において、ブートストラップサンプルを用いて独立に学習</li>
  <li>入力$\mathbf{x}$に対する予測値$Y_{M}$を出力する。
    <ul>
      <li>識別問題の場合: $y_{M}$の多数決</li>
      <li>回帰問題の場合: $Y_{M}(\mathbf{x})=\frac{1}{M}\sum_{i=1}^{M}y_{m}$</li>
    </ul>
  </li>
</ol>

<h3 id="実践">実践</h3>

<p><code class="highlighter-rouge">sklearn.ensemble.BaggingClassifier</code>でirisデータセットを分類する。</p>

<p>使用したコードは<a href="https://github.com/ysk24ok/swsk">こちら</a>。
また、notebookは<a href="https://github.com/ysk24ok/swsk/blob/master/notebooks/bagging.ipynb">こちら</a>。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s">'{}/../../'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())))</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_validation</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">BaggingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">iris</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">y_pred_tr_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_pred_te_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n_est</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
    <span class="n">n_est</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">tr_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">te_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">te_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="p">:</span>
        <span class="n">x_tr</span><span class="p">,</span> <span class="n">x_te</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">iris</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">te_idx</span><span class="p">]</span>
        <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_te</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">],</span> <span class="n">iris</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">te_idx</span><span class="p">]</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">BaggingClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_est</span><span class="p">)</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
        <span class="n">y_tr_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_tr</span><span class="p">)</span>
        <span class="n">y_te_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_te</span><span class="p">)</span>
        <span class="c">#print('oob_score: {}'.format(round(clf.oob_score, 5)))</span>
        <span class="n">tr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_tr</span><span class="p">,</span> <span class="n">y_tr_pred</span><span class="p">))</span>
        <span class="n">te_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_te</span><span class="p">,</span> <span class="n">y_te_pred</span><span class="p">))</span>
    <span class="n">y_pred_tr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">tr_list</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_list</span><span class="p">))</span>
    <span class="n">y_pred_te_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">te_list</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">te_list</span><span class="p">))</span>
<span class="n">y_pred_tr_sr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred_tr_list</span><span class="p">)</span>
<span class="n">y_pred_tr_sr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'b'</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mf">1.005</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'num estimators'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'accuracy against training data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">y_pred_te_sr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred_te_list</span><span class="p">)</span>
<span class="n">y_pred_te_sr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'b'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'num estimators'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'accuracy against test data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/images/hajipata/11/bagging_0_0.png" alt="png" />
<img src="/assets/images/hajipata/11/bagging_0_1.png" alt="png" /></p>

<p>弱学習器の数を増やしても過学習を起こしていないことがわかる。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">swsk</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">swsk</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">get_tree_graph</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iris</span><span class="p">)</span>
<span class="n">Image</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">create_png</span><span class="p">())</span>
</code></pre></div></div>

<p><img src="/assets/images/hajipata/11/bagging_1_0.png" alt="png" /></p>

<p>このようにノード数の多いややover-fitting気味な木でも<br />
baggingにより複数の弱学習器を組み合わせることで過学習を防ぐことができている。</p>

<h2 id="参考文献サイト">参考文献・サイト</h2>

<ul>
  <li><a href="https://www.morikita.co.jp/books/book/2235">はじめてのパターン認識</a> 第11章</li>
  <li><a href="http://ibisforest.org/index.php?%E3%83%96%E3%83%BC%E3%83%88%E3%82%B9%E3%83%88%E3%83%A9%E3%83%83%E3%83%97">ブートストラップ - 機械学習の「朱鷺の杜Wiki」</a></li>
  <li><a href="http://www.slideshare.net/holidayworking/ss-11948523">アンサンブル学習</a></li>
  <li><a href="http://scikit-learn.org/stable/modules/ensemble.html">1.11. Ensemble methods — scikit-learn 0.17.1 documentation</a></li>
  <li><a href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.BaggingClassifier.html#sklearn.ensemble.BaggingClassifier">sklearn.ensemble.BaggingClassifier — scikit-learn 0.17.1 documentation</a></li>
</ul>

            <ul class="social-buttons">
  <!-- hatena bookmark -->
  <li>
    <a href="http://b.hatena.ne.jp/entry/ysk24ok.github.io/2016/09/21/hajipata-bagging.html" class="hatena-bookmark-button" data-hatena-bookmark-title="はじめてのパターン認識 第11章 bagging - ysk24ok.github.io" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加">
      <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" />
    </a>
    <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  </li>
  <!-- twitter -->
  <li>
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </li>
</ul>

          </div>
        </div>
        <footer>
  This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
</footer>

      </div>
    </div>
  </body>
</html>
